---
import BaseLayout from "../layouts/BaseLayout.astro";
import CtaButton from "../components/ui/CtaButton.astro";
---

<BaseLayout title="Robotanics">
  <main class="page">
    <section class="stage" aria-label="Scroll zoom mask">
      <div class="sticky">
        <div class="frame">
          <video
            class="video"
            autoplay
            muted
            loop
            playsinline
            preload="auto"
            aria-hidden="true"
          >
            <source
              src="https://cdn.cosmos.so/7e7d92b0-8124-4f3d-b0c6-ea08668c3824.mp4"
              type="video/mp4"
            />
          </video>
        </div>
      </div>
    </section>
    <CtaButton href="#" label="Contact" />
  </main>
</BaseLayout>

<script>
  import gsap from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";
  import Lenis from "lenis";

  gsap.registerPlugin(ScrollTrigger);

  const lenis = new Lenis({ lerp: 0.08, smoothWheel: true });
  lenis.on("scroll", ScrollTrigger.update);
  gsap.ticker.add((t: number) => lenis.raf(t * 1000));
  gsap.ticker.lagSmoothing(0);

  // ScrollTrigger opnieuw berekenen na layout (nodig o.a. met Lenis)
  window.addEventListener("load", () => ScrollTrigger.refresh());
  requestAnimationFrame(() => setTimeout(ScrollTrigger.refresh, 100));

  const cta = document.querySelector<HTMLElement>("[data-cta]");
  const video = document.querySelector<HTMLVideoElement>(".video");
  const frame = document.querySelector<HTMLElement>(".frame");

  let maskProgress = 0;
  const MASK_START = 32;
  const MASK_END = 8000;

  function updateMaskSize() {
    if (!frame) return;
    const size = MASK_START + maskProgress * (MASK_END - MASK_START);
    frame.style.setProperty("--logo-mask-size", `${size}vw`);
  }

  updateMaskSize();

  ScrollTrigger.create({
    trigger: ".stage",
    start: "top top",
    end: "top+=300% top",
    scrub: true,
    onUpdate: (self) => {
      maskProgress = self.progress;
      updateMaskSize();
    },
  });

  if (cta) {
    // Start onder viewport (buiten canvas), dan bij trigger van onder in + pop
    gsap.set(cta, {
      opacity: 0,
      visibility: "visible",
      bottom: "2rem",
      xPercent: -50,
      y: "calc(100vh + 100%)",
    });

    ScrollTrigger.create({
      trigger: ".stage",
      start: "80% bottom",
      markers: false, // GSAP ScrollTrigger debug
      onEnter: () => {
        cta.style.pointerEvents = "auto";
        gsap.to(cta, {
          y: 0,
          opacity: 1,
          duration: 0.6,
          ease: "back.out(1.15)",
        });
      },
      onLeaveBack: () => {
        cta.style.pointerEvents = "none";
        gsap.to(cta, {
          y: "calc(100vh + 100%)",
          opacity: 0,
          duration: 0.35,
          ease: "power2.in",
        });
      },
    });
  }

  if (video) {
    video.addEventListener("loadeddata", () => {
      const p = video.play();
      if (p?.catch) p.catch(() => {});
    });
  }
</script>
